<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Cotizaciones - Mudanzas Express</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
        .text-primary { color: #3b82f6; }
        .loader {
            border-top-color: #3b82f6;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <!-- Importaciones de Firebase Firestore y Auth -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Configuración global de Firebase
        setLogLevel('Debug');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        let app, db, auth;
        let userId = 'anonymous';

        // Inicializar Firebase y Autenticar
        const initializeFirebase = async () => {
            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase Configuración no disponible.");
                document.getElementById('loading-message').textContent = "Error: Configuración de Firebase no disponible.";
                return;
            }
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                userId = auth.currentUser?.uid || 'no-auth';
                console.log("Firebase inicializado. User ID:", userId);
                
                // Una vez autenticado, iniciamos la escucha de las cotizaciones
                if (userId !== 'no-auth') {
                    startRealtimeListener(db, appId, userId);
                } else {
                    document.getElementById('loading-message').textContent = "Error: No se pudo obtener el User ID para cargar las cotizaciones.";
                    document.getElementById('loader').classList.add('hidden');
                }

            } catch (error) {
                console.error("Error al inicializar Firebase o autenticar:", error);
                document.getElementById('loading-message').textContent = `Error de autenticación: ${error.message}`;
                document.getElementById('loader').classList.add('hidden');
            }
        };

        // --- Función para iniciar la escucha de cotizaciones en tiempo real ---
        const startRealtimeListener = (db, appId, userId) => {
            const cotizacionesContainer = document.getElementById('cotizaciones-container');
            const loadingMessage = document.getElementById('loading-message');
            const loader = document.getElementById('loader');

            // Ruta de colección: /artifacts/{appId}/users/{userId}/cotizaciones
            const collectionPath = `artifacts/${appId}/users/${userId}/cotizaciones`;
            const cotizacionesRef = collection(db, collectionPath);
            const q = query(cotizacionesRef); // Puedes añadir .orderBy() aquí, pero se recomienda ordenar en el frontend para evitar errores de índice en Firestore

            // onSnapshot crea una conexión en tiempo real
            onSnapshot(q, (snapshot) => {
                loader.classList.add('hidden');
                cotizacionesContainer.innerHTML = ''; // Limpiar el contenedor
                loadingMessage.classList.add('hidden');

                if (snapshot.empty) {
                    cotizacionesContainer.innerHTML = '<p class="text-xl text-gray-500 text-center p-8">Aún no hay cotizaciones guardadas. ¡Prueba enviando una!</p>';
                    return;
                }

                snapshot.forEach(doc => {
                    const data = doc.data();
                    data.id = doc.id;
                    renderCotizacionCard(data, cotizacionesContainer);
                });

                document.getElementById('total-cotizaciones').textContent = snapshot.docs.length;
            }, (error) => {
                console.error("Error al escuchar cotizaciones:", error);
                loadingMessage.textContent = `Error de conexión: ${error.message}`;
                loader.classList.add('hidden');
            });
        };

        // --- Función para renderizar cada tarjeta de cotización ---
        const renderCotizacionCard = (data, container) => {
            const card = document.createElement('div');
            card.className = 'bg-white p-6 rounded-xl shadow-lg border-l-4 border-yellow-500 hover:shadow-xl transition duration-300';
            
            // Determinar si es Visita o Menaje
            const isVisita = data.metodoVolumen === 'Visita';
            const detailKey = isVisita ? 'fechaVisita' : 'inventarioManual';
            
            let detalleContent = '';
            if (isVisita) {
                detalleContent = `
                    <p class="mt-2 text-sm text-red-700 font-semibold">Visita Agendada: ${data.detalleVolumen.fechaVisita} a las ${data.detalleVolumen.horaVisita}</p>
                `;
            } else if (data.detalleVolumen.inventarioManual && Array.isArray(data.detalleVolumen.inventarioManual)) {
                // Si hay inventario manual, mostrar un resumen
                const totalItems = data.detalleVolumen.inventarioManual.reduce((acc, item) => acc + item.cantidad, 0);
                detalleContent = `
                    <p class="mt-2 text-sm text-green-700 font-semibold">Detalle Menaje: ${totalItems} artículos listados manualmente.</p>
                `;
            } else if (data.detalleVolumen.archivoSubido && data.detalleVolumen.archivoSubido !== 'N/A') {
                // Si hay archivo subido, mostrar su estado
                detalleContent = `
                    <p class="mt-2 text-sm text-blue-700 font-semibold">Detalle Menaje: Archivo Excel/CSV subido (${data.detalleVolumen.archivoSubido.length} filas).</p>
                `;
            } else {
                 detalleContent = `
                    <p class="mt-2 text-sm text-gray-500">Sin detalle de menaje (Solo datos iniciales).</p>
                `;
            }


            card.innerHTML = `
                <div class="flex justify-between items-start border-b pb-2 mb-2">
                    <h3 class="text-xl font-bold text-gray-800">${data.cliente.nombre}</h3>
                    <span class="text-xs font-medium px-3 py-1 rounded-full ${data.estado === 'Pendiente' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">
                        ${data.estado}
                    </span>
                </div>
                <p class="text-gray-600 mb-1">Email: <a href="mailto:${data.cliente.email}" class="text-primary hover:underline">${data.cliente.email}</a></p>
                <p class="text-gray-600 mb-1">Teléfono: ${data.cliente.telefono}</p>
                <p class="text-gray-600 mb-3">Fecha Mudanza: ${data.mudanza.fechaMudanza || 'N/A'}</p>

                <div class="text-sm bg-gray-50 p-3 rounded-lg">
                    <p class="font-semibold text-gray-700">Tipo de Servicio:</p>
                    <p class="text-gray-600">${data.mudanza.tipoMudanza} / ${data.mudanza.tipoInmueble}</p>
                    <p class="font-semibold text-gray-700 mt-2">Método de Volumen:</p>
                    <p class="text-gray-600">${data.metodoVolumen} ${detalleContent}</p>
                </div>
                <div class="mt-4 text-right">
                    <button onclick="verDetalle('${data.id}', this)" class="text-sm text-primary hover:text-blue-700 font-semibold transition duration-300">
                        Ver Detalle Completo
                    </button>
                </div>
                <div id="detalle-${data.id}" class="hidden mt-4 pt-4 border-t border-gray-200">
                    <!-- Aquí se cargará el JSON completo del documento -->
                    <pre class="bg-gray-800 text-white p-3 rounded-lg overflow-x-auto text-xs"></pre>
                </div>
            `;
            container.appendChild(card);
        };

        // --- Función global para ver el detalle completo (JSON) ---
        window.verDetalle = (docId, button) => {
            const detailDiv = document.getElementById(`detalle-${docId}`);
            const preElement = detailDiv.querySelector('pre');

            // Toggle de visibilidad
            detailDiv.classList.toggle('hidden');
            
            if (!detailDiv.classList.contains('hidden')) {
                // Mostrar JSON (lo buscamos en el snapshot local si fuera una app grande, pero aquí lo tenemos que compilar)
                
                // Nota: Firestore no permite obtener documentos por ID directamente desde onSnapshot sin usar getDoc,
                // así que usaremos el JSON completo del objeto data (que está dentro del scope de startRealtimeListener,
                // pero no lo podemos pasar directamente al onclick).
                // Para este ejemplo simple, mostraremos un mensaje indicando cómo obtenerlo realmente.
                
                preElement.textContent = "Datos completos:\nSe necesita un 'getDoc' para cargar el JSON completo aquí. Por ahora, estos son los datos que se guardaron:\n" + JSON.stringify(document.querySelector(`[data-doc-id="${docId}"]`)?.data || {Error: "Datos no encontrados en el cache del DOM."}, null, 2);
                
                // Mejor aún: ya que el código dentro del <script type="module"> no puede definir funciones globales fácilmente, 
                // re-compilaremos el JSON para el usuario a modo de ejemplo visual de lo que se guarda.
                preElement.textContent = JSON.stringify(window.allCotizations.find(c => c.id === docId), null, 2);
                button.textContent = 'Ocultar Detalle Completo';
            } else {
                button.textContent = 'Ver Detalle Completo';
            }
        };

        // Ejecutar inicialización al cargar el script
        window.onload = initializeFirebase;
    </script>
</head>
<body>

    <!-- 1. BARRA DE NAVEGACIÓN (HEADER) -->
    <header class="bg-white shadow-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <!-- Logo/Marca -->
            <a href="index.html#inicio" class="text-2xl font-bold text-primary hover:text-blue-700 transition duration-300">
                MUDANZAS EXPRESS
            </a>
            <!-- Menú de Navegación -->
            <nav id="desktop-menu">
                <ul class="flex space-x-6">
                    <li><a href="index.html" class="text-gray-600 hover:text-primary font-medium transition duration-300">← Volver a Inicio</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- 2. CONTENIDO DEL PANEL -->
    <main class="py-12 md:py-20">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
            <h1 class="text-4xl md:text-5xl font-extrabold text-center mb-4 text-gray-800">
                Panel de Cotizaciones Recibidas
            </h1>
            <p class="text-xl text-center text-gray-600 mb-10">
                Datos actualizados en tiempo real desde Firestore.
            </p>

            <div class="bg-primary text-white p-4 rounded-lg shadow-md mb-6 flex justify-between items-center">
                <h2 class="text-2xl font-semibold">Total de Solicitudes: <span id="total-cotizaciones" class="text-yellow-400 font-extrabold">0</span></h2>
                <p class="text-sm bg-blue-700 px-3 py-1 rounded-full">User ID: <span class="font-mono text-xs">${typeof __initial_auth_token !== 'undefined' ? (typeof __initial_auth_token === 'string' ? 'AUTENTICADO' : 'ANÓNIMO') : 'ANÓNIMO'}</span></p>
            </div>


            <!-- Loader y Mensajes -->
            <div id="loader" class="text-center p-8">
                <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-10 w-10 mx-auto"></div>
                <p id="loading-message" class="text-primary mt-2">Cargando cotizaciones...</p>
            </div>
            
            <!-- Contenedor de las Cotizaciones -->
            <div id="cotizaciones-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Las tarjetas de cotización se insertarán aquí por JavaScript -->
            </div>
        </div>
    </main>

    <!-- 3. PIE DE PÁGINA (FOOTER) -->
    <footer class="bg-gray-900 text-white py-8 mt-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <p class="mb-2">&copy; 2025 Mudanzas Express. Panel de Administración.</p>
            <a href="index.html" class="hover:text-primary transition duration-300 text-sm">Volver al Sitio Web Principal</a>
        </div>
    </footer>
</body>
</html>
