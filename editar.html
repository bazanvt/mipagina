<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Movimientos de Inventario</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f7f9;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            color: #333;
        }
        .container {
            display: flex;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            gap: 40px;
            min-width: 800px;
        }
        .action-panel {
            flex-shrink: 0;
            border-right: 1px solid #ddd;
            padding-right: 40px;
        }
        .form-panel {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }
        .form-group {
            flex: 1;
        }
        h3 {
            margin-top: 0;
            color: #555;
            font-size: 18px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-weight: bold;
        }
        input[type="radio"] {
            margin-right: 5px;
        }
        input[type="text"], input[type="number"], select {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }
        select {
            background-color: #f9f9f9;
        }
        .radio-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .radio-options label {
            display: flex;
            align-items: center;
            font-weight: normal;
        }
        .button-group {
            margin-top: 20px;
        }
        .btn {
            padding: 10px 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f0f0f0;
            cursor: pointer;
            font-size: 16px;
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
            width: 100%;
        }
        .btn-primary:hover {
            background-color: #0056b3;
        }
        .btn-secondary {
            background-color: #6c757d;
            color: white;
            border-color: #6c757d;
            width: 100%;
            margin-top: 10px;
        }
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        .stock-group {
            margin-top: 20px;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 5px;
            position: relative;
        }
        .stock-group h4 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #333;
            border-bottom: 1px solid #ccc;
            padding-bottom: 5px;
        }
        .stock-group p {
            margin: 5px 0;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
        }
        /* Color por defecto para el stock (azul) */
        .stock-group p span {
            font-weight: bold;
            color: #007bff;
        }
        /* Color para el stock pendiente de procesar (verde) */
        .stock-group p span.pending {
            color: #28a745;
        }
        /* Estilo para el mensaje de éxito */
        #success-message {
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            color: #28a745;
            font-weight: bold;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            white-space: nowrap;
        }
        #success-message.visible {
            opacity: 1;
        }
        #loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }
        .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #3498db;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loader-text {
            font-size: 18px;
            font-weight: bold;
            margin-top: 15px;
            color: #333;
        }
    </style>
</head>
<body>
    <div id="loader">
        <div class="spinner"></div>
        <div class="loader-text">Cargando datos, por favor espere...</div>
    </div>
    
    <div class="container" id="main-content" style="display:none;">
        <div class="action-panel">
            <h3>Acción</h3>
            <div class="radio-options">
                <label><input type="radio" name="accion" value="cambio_bodega"> Cambio de Bodega</label>
                <label><input type="radio" name="accion" value="llegada"> Llegada</label>
                <label><input type="radio" name="accion" value="ajuste"> Ajuste</label>
                <label><input type="radio" name="accion" value="salida_directa"> Salida Directa</label>
                <label><input type="radio" name="accion" value="salida_tienda"> Salida a Tienda</label>
            </div>
            <div class="button-group">
                <button class="btn" id="nuevo-producto-btn">Nuevo Producto</button>
            </div>
            
            <div class="form-group" id="motivo-group" style="display: none; margin-top: 20px;">
                <label for="motivo">Motivo del Ajuste</label>
                <input type="text" id="motivo" placeholder="Especifique el motivo">
            </div>
        </div>
        <div class="form-panel">
            <div class="form-row">
                <div class="form-group">
                    <label for="producto">Producto</label>
                    <select id="producto">
                        <option value="">Seleccione un producto</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="color">Color</label>
                    <select id="color">
                        <option value="">Seleccione un color</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="medida">Medida</label>
                    <select id="medida">
                        <option value="">Seleccione una medida</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="marca">Marca</label>
                    <select id="marca">
                        <option value="">Seleccione una marca</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="cantidad">Cantidad</label>
                    <input type="number" id="cantidad" placeholder="Cantidad" min="0">
                </div>
                <div class="form-group" id="salio-de-group" style="display: none;">
                    <label for="salio-de">Salió de:</label>
                    <select id="salio-de">
                        <option value="">Seleccione una bodega</option>
                        <option value="bodega1">Bodega 1</option>
                        <option value="bodega2">Bodega 2</option>
                        <option value="bodega3">Bodega 3</option>
                    </select>
                </div>
                <div class="form-group" id="llego-a-group" style="display: none;">
                    <label for="llego-a">Llegó a:</label>
                    <select id="llego-a">
                        <option value="">Seleccione una bodega</option>
                        <option value="bodega1">Bodega 1</option>
                        <option value="bodega2">Bodega 2</option>
                        <option value="bodega3">Bodega 3</option>
                    </select>
                </div>
            </div>
            
            <div class="stock-group">
                <h4>Stocks Actuales</h4>
                <p>Bodega 1: <span id="bodega1">0</span></p>
                <p>Bodega 2: <span id="bodega2">0</span></p>
                <p>Bodega 3: <span id="bodega3">0</span></p>
                <p>Suma de Stocks: <span id="stock-total">0</span></p>
                <span id="success-message">¡Procesado con éxito!</span>
            </div>
            <div style="text-align: center; margin-top: auto;">
                <button class="btn btn-primary" id="btn-aceptar">Aceptar</button>
                <button class="btn btn-secondary" id="abrir-doc">Abrir Documento</button>
            </div>
        </div>
    </div>
    
    <script>
        let inventarioData = [];
        const dbName = 'Alma.nsf';
        const serverUrl = `https://movingcrm.mx/${dbName}`;

        async function fetchAllData(start = 1, allEntries = []) {
            const pageSize = 500;
            const url = `${serverUrl}/articulosAll?ReadViewEntries&Start=${start}&Count=${pageSize}`;
            
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Error al obtener datos: ${response.status} ${response.statusText}`);
                }
                const text = await response.text();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(text, "text/xml");
                const entries = xmlDoc.getElementsByTagName('viewentry');

                if (entries.length === 0) {
                    return allEntries;
                }

                for (let entry of entries) {
                    const cols = entry.getElementsByTagName('entrydata');
                    allEntries.push({
                        producto: cols[0]?.querySelector('text')?.textContent || '',
                        color: cols[1]?.querySelector('text')?.textContent || '',
                        medida: cols[2]?.querySelector('text')?.textContent || '',
                        marca: cols[3]?.querySelector('text')?.textContent || '',
                        unid: entry.getAttribute('unid'),
                        bodega1: parseInt(cols[4]?.querySelector('number')?.textContent) || 0,
                        bodega2: parseInt(cols[5]?.querySelector('number')?.textContent) || 0,
                        bodega3: parseInt(cols[6]?.querySelector('number')?.textContent) || 0
                    });
                }
                return fetchAllData(start + pageSize, allEntries);
            } catch (err) {
                console.error("Error al cargar datos: ", err);
                throw err;
            }
        }

        function llenarSelect(selectId, dataSet) {
            const select = document.getElementById(selectId);
            const sortedData = Array.from(dataSet).filter(item => item).sort();
            select.innerHTML = `<option value="">Seleccione un ${selectId.replace(/-/g, ' ')}</option>`;
            sortedData.forEach(item => {
                const option = document.createElement('option');
                option.value = item;
                option.textContent = item;
                select.appendChild(option);
            });
        }

        function actualizarStocks() {
            const producto = document.getElementById('producto').value;
            const color = document.getElementById('color').value;
            const medida = document.getElementById('medida').value;
            const marca = document.getElementById('marca').value;

            const item = inventarioData.find(d => 
                d.producto === producto && 
                d.color === color && 
                d.medida === medida &&
                d.marca === marca
            );
            
            document.getElementById('bodega1').textContent = item ? item.bodega1 : 0;
            document.getElementById('bodega2').textContent = item ? item.bodega2 : 0;
            document.getElementById('bodega3').textContent = item ? item.bodega3 : 0;
            document.getElementById('stock-total').textContent = item ? item.bodega1 + item.bodega2 + item.bodega3 : 0;
            document.querySelectorAll('.stock-group p span').forEach(span => {
                span.classList.remove('pending');
            });
        }

        function handleProductChange() {
            const productoSeleccionado = document.getElementById('producto').value;
            const colorSelect = document.getElementById('color');
            const medidaSelect = document.getElementById('medida');
            const marcaSelect = document.getElementById('marca');

            colorSelect.innerHTML = '<option value="">Seleccione un color</option>';
            medidaSelect.innerHTML = '<option value="">Seleccione una medida</option>';
            marcaSelect.innerHTML = '<option value="">Seleccione una marca</option>';
            
            if (productoSeleccionado) {
                const coloresUnicos = new Set(inventarioData
                    .filter(d => d.producto === productoSeleccionado)
                    .map(d => d.color));
                llenarSelect('color', coloresUnicos);
            }
            
            actualizarStocks();
        }

        function handleColorChange() {
            const productoSeleccionado = document.getElementById('producto').value;
            const colorSeleccionado = document.getElementById('color').value;
            const medidaSelect = document.getElementById('medida');
            const marcaSelect = document.getElementById('marca');

            medidaSelect.innerHTML = '<option value="">Seleccione una medida</option>';
            marcaSelect.innerHTML = '<option value="">Seleccione una marca</option>';

            if (productoSeleccionado && colorSeleccionado) {
                const medidasUnicas = new Set(inventarioData
                    .filter(d => d.producto === productoSeleccionado && d.color === colorSeleccionado)
                    .map(d => d.medida));
                llenarSelect('medida', medidasUnicas);
            }

            actualizarStocks();
        }

        function handleMedidaChange() {
            const productoSeleccionado = document.getElementById('producto').value;
            const colorSeleccionado = document.getElementById('color').value;
            const medidaSeleccionada = document.getElementById('medida').value;
            const marcaSelect = document.getElementById('marca');

            marcaSelect.innerHTML = '<option value="">Seleccione una marca</option>';

            if (productoSeleccionado && colorSeleccionado && medidaSeleccionada) {
                const marcasUnicas = new Set(inventarioData
                    .filter(d => d.producto === productoSeleccionado && d.color === colorSeleccionado && d.medida === medidaSeleccionada)
                    .map(d => d.marca));
                llenarSelect('marca', marcasUnicas);
            }

            actualizarStocks();
        }

        function actualizarStocksConMovimiento() {
            const accion = document.querySelector('input[name="accion"]:checked')?.value;
            const cantidad = parseInt(document.getElementById('cantidad').value) || 0;
            const salioDe = document.getElementById('salio-de').value;
            const llegoA = document.getElementById('llego-a').value;
            
            const producto = document.getElementById('producto').value;
            const color = document.getElementById('color').value;
            const medida = document.getElementById('medida').value;
            const marca = document.getElementById('marca').value;

            const item = inventarioData.find(d => 
                d.producto === producto && 
                d.color === color && 
                d.medida === medida &&
                d.marca === marca
            );

            document.querySelectorAll('.stock-group p span').forEach(span => {
                span.classList.remove('pending');
            });
            
            if (!item) {
                actualizarStocks();
                return;
            }

            let nuevoItem = { ...item };
            
            if (accion === 'llegada' && llegoA) {
                nuevoItem[llegoA] += cantidad;
                document.getElementById(llegoA).classList.add('pending');
            } else if ((accion === 'salida_directa' || accion === 'salida_tienda' || accion === 'ajuste') && salioDe) {
                nuevoItem[salioDe] -= cantidad;
                document.getElementById(salioDe).classList.add('pending');
            } else if (accion === 'cambio_bodega' && salioDe && llegoA) {
                nuevoItem[salioDe] -= cantidad;
                nuevoItem[llegoA] += cantidad;
                document.getElementById(salioDe).classList.add('pending');
                document.getElementById(llegoA).classList.add('pending');
            }
            
            document.getElementById('bodega1').textContent = nuevoItem.bodega1;
            document.getElementById('bodega2').textContent = nuevoItem.bodega2;
            document.getElementById('bodega3').textContent = nuevoItem.bodega3;
            document.getElementById('stock-total').textContent = nuevoItem.bodega1 + nuevoItem.bodega2 + nuevoItem.bodega3;
        }

        async function procesarMovimiento() {
            document.getElementById('main-content').style.display = 'none';
            document.getElementById('loader').style.display = 'block';

            const accion = document.querySelector('input[name="accion"]:checked')?.value;
            const producto = document.getElementById('producto').value;
            const color = document.getElementById('color').value;
            const medida = document.getElementById('medida').value;
            const marca = document.getElementById('marca').value;
            const cantidad = parseInt(document.getElementById('cantidad').value) || 0;
            const salioDe = document.getElementById('salio-de').value;
            const llegoA = document.getElementById('llego-a').value;
            const motivo = document.getElementById('motivo').value;
            
            const successMessage = document.getElementById('success-message');
            
            successMessage.classList.remove('visible');

            if (!accion || !producto || !color || !medida || !marca || cantidad <= 0) {
                alert('Por favor, complete todos los campos obligatorios y asegúrese de que la cantidad sea mayor a 0.');
                document.getElementById('loader').style.display = 'none';
                document.getElementById('main-content').style.display = 'flex';
                return;
            }

            if (accion === 'cambio_bodega' && (!salioDe || !llegoA)) {
                alert('Para el "Cambio de Bodega", debe seleccionar una bodega de origen y una de destino.');
                document.getElementById('loader').style.display = 'none';
                document.getElementById('main-content').style.display = 'flex';
                return;
            }
            if ((accion === 'salida_directa' || accion === 'salida_tienda' || accion === 'ajuste') && !salioDe) {
                alert('Para esta acción, debe seleccionar la bodega de la que salió el producto.');
                document.getElementById('loader').style.display = 'none';
                document.getElementById('main-content').style.display = 'flex';
                return;
            }
            if (accion === 'llegada' && !llegoA) {
                 alert('Para esta acción, debe seleccionar la bodega de destino.');
                document.getElementById('loader').style.display = 'none';
                document.getElementById('main-content').style.display = 'flex';
                return;
            }
            if (accion === 'ajuste' && !motivo) {
                 alert('Por favor, ingrese el motivo del ajuste.');
                document.getElementById('loader').style.display = 'none';
                document.getElementById('main-content').style.display = 'flex';
                return;
            }

            const item = inventarioData.find(d => d.producto === producto && d.color === color && d.medida === medida && d.marca === marca);
            if (!item) {
                alert('El producto no se encontró en los datos del inventario. Por favor, selecciona un producto válido.');
                document.getElementById('loader').style.display = 'none';
                document.getElementById('main-content').style.display = 'flex';
                return;
            }
            if ((accion === 'salida_directa' || accion === 'salida_tienda' || accion === 'cambio_bodega' || accion === 'ajuste') && item[salioDe] < cantidad) {
                alert(`No hay suficiente stock (${item[salioDe]}) en la bodega de salida para realizar esta operación.`);
                document.getElementById('loader').style.display = 'none';
                document.getElementById('main-content').style.display = 'flex';
                return;
            }

            const formData = new FormData();
            formData.append('Form', 'movimientos');
            formData.append('accion', accion);
            formData.append('producto', producto);
            formData.append('color', color);
            formData.append('medida', medida);
            formData.append('marca', marca);
            formData.append('cantidad', cantidad);
            if (salioDe) formData.append('salioDe', salioDe);
            if (llegoA) formData.append('llegoA', llegoA);
            if (motivo) formData.append('motivo', motivo);

            try {
                const saveUrl = `${serverUrl}/movimientos?Createdocument`;
                const response = await fetch(saveUrl, {
                    method: 'POST',
                    body: formData
                });
                if (!response.ok) {
                    throw new Error(`Error al guardar el movimiento: ${response.status}`);
                }
                
                if (accion === 'llegada') {
                    item[llegoA] += cantidad;
                } else if (accion === 'salida_directa' || accion === 'salida_tienda' || accion === 'ajuste') {
                    item[salioDe] -= cantidad;
                } else if (accion === 'cambio_bodega') {
                    item[salioDe] -= cantidad;
                    item[llegoA] += cantidad;
                }

                await enviarDatosForm25(item);
                
                limpiarFormulario();
                actualizarStocks();

                successMessage.classList.add('visible');
                setTimeout(() => {
                    successMessage.classList.remove('visible');
                }, 3000);
                
            } catch (error) {
                console.error('Error durante el proceso de guardar y abrir:', error);
                alert('Hubo un error al procesar el movimiento. Revisa la consola para más detalles.');
            } finally {
                document.getElementById('loader').style.display = 'none';
                document.getElementById('main-content').style.display = 'flex';
            }
        }

        function toggleBodegaSelects() {
            const accion = document.querySelector('input[name="accion"]:checked')?.value;
            const salioDeGroup = document.getElementById('salio-de-group');
            const llegoAGroup = document.getElementById('llego-a-group');
            const motivoGroup = document.getElementById('motivo-group');    
            
            salioDeGroup.style.display = 'none';
            llegoAGroup.style.display = 'none';
            motivoGroup.style.display = 'none';    

            const cantidadInput = document.getElementById('cantidad');
            cantidadInput.value = '';

            document.getElementById('salio-de').value = '';
            document.getElementById('llego-a').value = '';

            switch (accion) {
                case 'cambio_bodega':
                    salioDeGroup.style.display = 'block';
                    llegoAGroup.style.display = 'block';
                    break;
                case 'llegada':
                    llegoAGroup.style.display = 'block';
                    break;
                case 'ajuste':
                    salioDeGroup.style.display = 'block';
                    motivoGroup.style.display = 'block';    
                    break;
                case 'salida_directa':
                case 'salida_tienda':
                    salioDeGroup.style.display = 'block';
                    break;
            }
            actualizarStocks();
        }

        function limpiarFormulario() {
            document.getElementById('cantidad').value = '';
            document.getElementById('motivo').value = '';
            document.getElementById('salio-de').value = '';
            document.getElementById('llego-a').value = '';
            document.querySelectorAll('input[name="accion"]').forEach(radio => radio.checked = false);
            toggleBodegaSelects();
        }

        async function initPage() {
            const mainContent = document.getElementById('main-content');
            const loader = document.getElementById('loader');

            try {
                inventarioData = await fetchAllData();
                
                const productosUnicos = new Set(inventarioData.map(d => d.producto));
                llenarSelect('producto', productosUnicos);
                
                document.getElementById('producto').addEventListener('change', handleProductChange);
                document.getElementById('color').addEventListener('change', handleColorChange);
                document.getElementById('medida').addEventListener('change', handleMedidaChange);
                document.getElementById('marca').addEventListener('change', actualizarStocksConMovimiento);
                
                document.getElementById('cantidad').addEventListener('input', actualizarStocksConMovimiento);
                document.getElementById('salio-de').addEventListener('change', actualizarStocksConMovimiento);
                document.getElementById('llego-a').addEventListener('change', actualizarStocksConMovimiento);

                document.getElementById('btn-aceptar').addEventListener('click', procesarMovimiento);
                document.getElementById('abrir-doc').addEventListener('click', function() {
                    var producto = document.getElementById("producto").value;
                    var color = document.getElementById("color").value;
                    var medida = document.getElementById("medida").value;
                    var marca = document.getElementById("marca").value;
                    
                    if (!producto || !color || !medida || !marca) {
                        alert("Por favor, selecciona un producto, color, medida y marca para abrir el documento.");
                        return;
                    }

                    const item = inventarioData.find(d => 
                        d.producto === producto && 
                        d.color === color && 
                        d.medida === medida &&
                        d.marca === marca
                    );

                    if (item && item.unid) {
                        var url = `${serverUrl}/articulo25/${item.unid}?OpenDocument`;
                        window.open(url, "_blank");
                    } else {
                        alert("No se pudo encontrar el documento para abrir. Por favor, asegúrate de que el producto existe en la base de datos.");
                    }
                });

                // NUEVA FUNCIÓN PARA EL BOTÓN "NUEVO PRODUCTO"
                document.getElementById('nuevo-producto-btn').addEventListener('click', function() {
                    const createUrl = `${serverUrl}/pArticulo26?OpenPage`;
        //            window.open(createUrl, "_blank");

window.open(createUrl, "nuevoProductoPopup", "width=650,height=700,top=100,left=300,toolbar=no,menubar=no,location=no,status=no,resizable=yes"); 

                });
                
                document.querySelectorAll('input[name="accion"]').forEach(radio => {
                    radio.addEventListener('change', toggleBodegaSelects);
                });

                loader.style.display = 'none';
                mainContent.style.display = 'flex';
                actualizarStocks();

            } catch (err) {
                console.error("Error al cargar los datos del inventario: ", err);
                loader.style.display = 'none';
                mainContent.style.display = 'flex';
                mainContent.innerHTML = `<p style="color: red; text-align: center; max-width: 500px; margin: auto;">Hubo un error al cargar los datos. Por favor, revisa la consola para más detalles. Error: ${err.message}</p>`;
            }
        }

        document.addEventListener('DOMContentLoaded', initPage);

        async function enviarDatosForm25(item) {
            const form25Data = new FormData();
            
            if (item.unid) {
                form25Data.append('$$Return', '1');
                form25Data.append('$$OpenDominoDocument', '1');
                form25Data.append('UNID', item.unid);
                form25Data.append('Form', 'articulo25');
                form25Data.append('stock1', item.bodega1);
                form25Data.append('stock2', item.bodega2);
                form25Data.append('stock3', item.bodega3);
                
                const updateUrl = `${serverUrl}/articulo25/${item.unid}?SaveDocument`;

                try {
                    const response = await fetch(updateUrl, {
                        method: 'POST',
                        body: form25Data
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Error al actualizar el documento de artículo: ${response.status}`);
                    }
                    console.log('Datos de bodegas enviados a articulo25 con éxito.');
                } catch (error) {
                    console.error('Error al enviar datos a articulo25:', error);
                }
            } else {
                console.error('No se pudo encontrar el UNID del documento para actualizarlo.');
            }
        }

    </script>
</body>
</html>
